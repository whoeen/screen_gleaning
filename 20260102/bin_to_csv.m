%% 1. 설정 (Configuration)
% =========================================================================
% 입력 파일과 출력 파일의 경로 및 데이터 형식을 지정하는 섹션입니다.
% =========================================================================

inputFile = 'RefCurve_2026-01-02_0_152147.Wfm.bin';   % 읽어올 바이너리 파일 이름
outputFile = 'RefCurve_2026-01-02_0_152147.Wfm.csv'; % 저장할 CSV 파일 이름

% [중요] 데이터 정밀도 (Precision) 설정
% 바이너리 스트림을 몇 바이트 단위로 끊어서 읽을지 결정합니다.
% - 'single': 32비트 부동소수점 (일반적인 실수 데이터, C의 float)
% - 'double': 64비트 부동소수점 (MATLAB 기본, 정밀한 계산용)
% - 'int16' : 16비트 정수 (오실로스코프, DAQ 데이터 등)
% - 'uint8' : 8비트 부호 없는 정수 (이미지 픽셀 데이터 등)
dataType = 'int16'; 

% [선택] 데이터 형태 (Reshape) 설정
% 데이터가 1차원 배열이 아니라, 여러 채널(열)을 가진 경우 설정합니다.
% 예: 2채널 오디오라면 2, 센서가 4개라면 4
numChannels = 1; 

% [선택] 엔디안 (Endianness) 설정
% 데이터 기록 방식이 'ieee-le'(리틀 엔디안)인지 'ieee-be'(빅 엔디안)인지 설정.
% PC 기반 데이터는 대부분 리틀 엔디안('l')입니다.
machineFormat = 'l'; 

%% 2. 파일 읽기 (File Reading)
% =========================================================================
% 바이너리 파일을 열고 raw 데이터를 메모리로 로드합니다.
% =========================================================================

% fopen: 파일을 읽기 전용('r') 바이너리 모드('b')로 엽니다.
fid = fopen(inputFile, 'rb', machineFormat);

% 파일 열기 실패 시 예외 처리
if fid == -1
    error('오류: 파일을 열 수 없습니다. 파일 경로와 이름을 확인하세요.');
end

% fread: 파일 식별자(fid)로부터 데이터를 읽습니다.
% - Inf: 파일의 끝(End of File)까지 모든 데이터를 읽으라는 의미입니다.
% - dataType: 앞서 설정한 데이터 형식(예: 'single')으로 해석합니다.
% - rawData: 읽어온 데이터가 저장되는 열 벡터(Column Vector)입니다.
rawData = fread(fid, Inf, dataType);

% 파일 리소스 해제 (메모리 누수 방지)
fclose(fid);

% 읽어온 데이터 개수 확인 (디버깅용 출력)
fprintf('파일 읽기 완료: 총 %d 개의 샘플을 읽었습니다.\n', length(rawData));


%% 3. 데이터 가공 (Data Processing)
% =========================================================================
% 1차원 벡터로 읽힌 데이터를 CSV 형식에 맞게 2차원 행렬로 변환합니다.
% =========================================================================

% 채널 수에 맞춰 데이터 형태 변환 (Reshape)
if numChannels > 1
    % 전체 샘플 개수가 채널 수로 나누어 떨어지는지 확인
    if mod(length(rawData), numChannels) ~= 0
        warning('경고: 전체 데이터 길이가 채널 수의 배수가 아닙니다. 마지막 일부 데이터가 제외될 수 있습니다.');
        % 나누어 떨어지는 길이만큼만 잘라냄
        len = floor(length(rawData) / numChannels) * numChannels;
        rawData = rawData(1:len);
    end
    
    % reshape(데이터, 행 개수, 열 개수)
    % MATLAB은 열 우선(Column-major) 순서이므로, 데이터를 먼저 행렬로 만든 뒤 전치(Transpose)합니다.
    % 많은 바이너리 파일이 [Ch1, Ch2, Ch1, Ch2...] 순서로 인터리빙(Interleaving) 되어 있다고 가정합니다.
    matrixData = reshape(rawData, numChannels, []).'; 
else
    % 단일 채널인 경우 그대로 사용
    matrixData = rawData;
end


%% 4. 파일 저장 (File Writing)
% =========================================================================
% 가공된 행렬 데이터를 CSV 텍스트 파일로 내보냅니다.
% =========================================================================

try
    % writematrix: R2019a 버전부터 도입된 함수로, 행렬을 텍스트 파일로 저장하는 가장 권장되는 방법입니다.
    % 이전 버전 사용 시 'csvwrite(outputFile, matrixData)'를 사용하십시오.
    writematrix(matrixData, outputFile);
    
    fprintf('저장 완료: %s 파일이 생성되었습니다.\n', outputFile);
catch ME
    % 쓰기 권한 부족 등의 오류 발생 시 메시지 출력
    fprintf('오류 발생: 파일을 저장하는 중 문제가 발생했습니다.\n');
    fprintf('상세 내용: %s\n', ME.message);
end